# Intercom CSV Parser for Bonus Calculator

A Node.js script that transforms Intercom CSV exports into JSON format suitable for the bonus calculation application.

## Features

- âœ… **Dynamic header detection** - Automatically scans the file to find the header row (no hardcoded row numbers)
- âœ… **Dynamic column mapping** - Finds columns by exact header names regardless of position
- âœ… **Handles 17-column Intercom format** - Works with full Intercom exports
- âœ… **Smart metadata skipping** - Automatically skips all metadata rows before the header
- âœ… **Auto-detects and skips Summary row** - Filters out summary statistics
- âœ… **Smart number extraction** - Removes commas (4,437 â†’ 4437), handles dashes as null
- âœ… **Flexible CSAT parsing** - Handles both "96.9%" and "87.7% (822/937)" formats
- âœ… **Special character support** - Properly handles names like "PÃ©rez", "Blay i GarcÃ­a"
- âœ… **Inactive user filtering** - Skips rows with all dashes (inactive teammates)
- âœ… **Data quality validation** - Identifies and reports incomplete records
- âœ… **Detailed logging** - Shows header detection, column mapping, data quality, and statistics
- âœ… Outputs clean JSON with summary analytics

## Installation

No dependencies required! Uses only Node.js built-in modules.

```bash
# Make the script executable (optional)
chmod +x parseIntercomCSV.js
```

## Usage

### Basic Usage

```bash
node parseIntercomCSV.js input.csv
```

This will create `output.json` in the current directory.

### Specify Output File

```bash
node parseIntercomCSV.js input.csv my-output.json
```

### Example

```bash
node parseIntercomCSV.js sample_intercom.csv team-bonuses.json
```

## Input Format

The script expects an Intercom CSV export with the following structure:

**Row Structure:**
- **Variable metadata rows:** Report title, date, type, etc. - Automatically skipped
- **Header row:** Automatically detected by looking for "Teammate", "Closed conversations by teammates", and "Teammate CSAT score"
- **Summary row:** Automatically skipped (contains "Summary" in the name column)
- **Team member data:** All rows after the header (excluding Summary)

**Required Columns (out of 17 total):**
The parser dynamically scans the file to find the header row and maps columns by exact name:
1. `Teammate` - Agent/team member name
2. `Closed conversations by teammates` - Number of conversations closed
3. `Teammate CSAT score` - Customer satisfaction score

**All 17 Columns in Intercom Export:**
```
1. Teammate
2. Conversations assigned
3. Conversations opened
4. Conversations closed
5. Conversations unassigned
6. Conversations reassigned
7. Closed conversations by teammates â† Used
8. Office hours conversations closed
9. First response time (median)
10. Close time (median)
11. Replies sent
12. Teammate CSAT score â† Used
13. CSAT responses
14. Rated conversations
15. Tags added
16. Internal notes added
17. Conversations you started
```

**Example CSV:**
```csv
Intercom Report
Export Date: 2025-01-17
Report Type: Team Performance
Period: January 2025
Generated by: Manager

"Teammate","Conversations assigned",...,"Closed conversations by teammates","Teammate CSAT score",...
"Summary","4,959",...,"4,437","87.7% (822/937)",...
"Anna","936",...,"639","96.9%",...
"Yesenia","523",...,"467","80.9%",...
```

## Output Format

The script outputs a JSON array with the following structure:

```json
[
  {
    "name": "John Smith",
    "closedConversations": 1459,
    "csatScore": 92.5
  },
  {
    "name": "Jane Doe",
    "closedConversations": 987,
    "csatScore": 89.3
  },
  {
    "name": "Emily Davis",
    "closedConversations": null,
    "csatScore": null
  }
]
```

## Data Cleaning

The script performs the following transformations:

### 1. Number Cleaning
- Input: `1,459` or `2,341` â†’ Output: `1459`, `2341`
- Input: `-` (dash) â†’ Output: `null`
- Input: empty/whitespace â†’ Output: `null`

### 2. CSAT Extraction (Multiple Formats)
- Input: `96.9%` â†’ Output: `96.9`
- Input: `87.7% (822/937)` â†’ Output: `87.7`
- Input: `-` (dash) â†’ Output: `null`

### 3. Dynamic Column Detection
The parser searches for exact column names:
- `Teammate` (not "Team Member" or "Name")
- `Closed conversations by teammates` (exact match)
- `Teammate CSAT score` (exact match)

If columns aren't found, the parser shows available columns and exits with an error.

## Example Output

When you run the script, you'll see detailed logging:

```
ðŸ“‚ Reading CSV from: sample_intercom_17col.csv
ðŸ’¾ Output will be saved to: output.json


ðŸ” Starting CSV parsing...

â­ï¸  Skipping metadata row 1
â­ï¸  Skipping metadata row 2
â­ï¸  Skipping metadata row 3
â­ï¸  Skipping metadata row 4
â­ï¸  Skipping metadata row 5

ðŸ“‹ Header row found at line 7 (17 columns total)

âœ… Column mapping successful:
   â€¢ "Teammate" found at column 1
   â€¢ "Closed conversations by teammates" found at column 7
   â€¢ "Teammate CSAT score" found at column 12

ðŸ“Š Processing data rows...

â­ï¸  Skipping Summary row at line 8
âœ… Parsed: Anna - 639 chats - 96.9% CSAT
âœ… Parsed: Yesenia - 467 chats - 80.9% CSAT
âœ… Parsed: Luis - 701 chats - 92.3% CSAT
âœ… Parsed: Maria - 378 chats - 88.5% CSAT
âœ… Parsed: Carlos - 256 chats - 91.7% CSAT
â­ï¸  Row 14: Sofia - All data is "-", skipping
âœ… Parsed: Diego - 189 chats - 94.2% CSAT

============================================================

âœ¨ Parsing complete!

ðŸ“Š Summary:
   Total teammates: 6
   With chat data: 6 (100.0%)
   With CSAT data: 6 (100.0%)
   Complete records: 6 (100.0%)

ðŸ“ˆ Averages:
   Avg conversations: 438
   Avg CSAT: 90.8%

âœ… Successfully saved 6 records to output.json

ðŸŽ‰ Done!
```

### Data Quality Indicators

- âœ… **Green checkmark** - Complete record with both chats and CSAT
- âš ï¸ **Warning icon** - Incomplete record (missing chats or CSAT)
- â­ï¸ **Skip icon** - Row was skipped (metadata, summary, etc.)

## Integration with Bonus Calculator

Once you have the JSON output, you can:

1. **Manual Import**: Open the JSON file and copy the data
2. **Batch Calculate**: Use the data to calculate bonuses for multiple team members
3. **API Integration**: Send the JSON to a backend service

### Example Integration Code

```javascript
// Load the parsed data
const teamData = require('./output.json');

// Calculate bonuses for each team member
teamData.forEach(member => {
    if (member.closedConversations && member.csatScore) {
        console.log(`Calculating bonus for ${member.name}...`);
        // Use the bonus calculator with member.closedConversations and member.csatScore
    }
});
```

## Error Handling

The script handles common issues:

- âœ… Missing input file
- âœ… Invalid CSV format
- âœ… Missing columns
- âœ… Invalid numeric data
- âœ… Empty rows

## Testing

A sample CSV file is included: `sample_intercom.csv`

Test the script:

```bash
node parseIntercomCSV.js sample_intercom.csv test-output.json
```

## Troubleshooting

### Issue: "No input file specified"
**Solution**: Provide the CSV file path as the first argument

### Issue: "Input file not found"
**Solution**: Check that the file path is correct and the file exists

### Issue: Invalid data in output
**Solution**: Verify your CSV matches the expected format (metadata in rows 1-5, header in row 6)

### Issue: Summary row not skipped
**Solution**: Ensure the Summary row contains the word "summary" (case-insensitive)

## Advanced Usage

### Using as a Module

You can import the parser functions in your own Node.js code:

```javascript
const { parseIntercomCSV, cleanNumber, extractCSAT } = require('./parseIntercomCSV');

// Parse a CSV file
const data = await parseIntercomCSV('input.csv');

// Use individual functions
const num = cleanNumber('1,459'); // 1459
const csat = extractCSAT('92.5% (850/920)'); // 92.5
```

## License

MIT

## Support

For issues or questions, please refer to the bonus calculator documentation.
